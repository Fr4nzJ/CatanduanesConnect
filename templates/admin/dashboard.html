{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
<meta name="csrf-token" content="{{ csrf_token() }}" />
<style>
    .table-loading {
        position: relative;
        min-height: 200px;
    }
    
    .table-loading::after {
        content: 'Loading...';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 1rem;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
<!-- Toast Container -->
<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>

<!-- Management Modals -->
<!-- User Management Modal -->
<div class="modal fade" id="userManagementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Users</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Resume</th>
                                <th>Permit</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr><td colspan="7" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Business Management Modal -->
<div class="modal fade" id="businessManagementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Businesses</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Owner</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="businesses-table">
                            <tr><td colspan="4" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Content Management Modal -->
<div class="modal fade" id="contentManagementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#jobs">Jobs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#services">Services</a>
                    </li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content mt-3">
                    <div id="jobs" class="tab-pane active">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Business</th>
                                        <th>Posted</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="jobs-table">
                                    <tr><td colspan="4" class="text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="services" class="tab-pane fade">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Posted By</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="services-table">
                                    <tr><td colspan="4" class="text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Dashboard Content -->
<div class="container-fluid py-4 admin-dashboard">
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="row mb-4">
        {% if total_counts %}
        <div class="col-md-2 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Total Users</h6>
                    <h2 class="card-title mb-0">{{ total_counts.users }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Businesses</h6>
                    <h2 class="card-title mb-0">{{ total_counts.businesses }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Active Jobs</h6>
                    <h2 class="card-title mb-0">{{ total_counts.jobs }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Services</h6>
                    <h2 class="card-title mb-0">{{ total_counts.services }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Applications</h6>
                    <h2 class="card-title mb-0">{{ total_counts.applications }}</h2>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Admin Dashboard</h1>
        <div class="btn-group">
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#userManagementModal" onclick="loadUsers()">
                <i class="bi bi-people"></i> Manage Users
            </button>
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#businessManagementModal" onclick="loadBusinesses()">
                <i class="bi bi-building"></i> Manage Businesses
            </button>
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#contentManagementModal" onclick="loadContent()">
                <i class="bi bi-file-text"></i> Manage Content
            </button>
            <a href="{{ url_for('admin_blueprint.verify_users_list') }}" class="btn btn-outline-warning">
                <i class="bi bi-person-check"></i> Verify Users
            </a>
            <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#documentReviewModal" onclick="loadPendingDocuments()">
                <i class="bi bi-file-earmark-check"></i> Review Documents
            </button>
        </div>
    </div>

    <!-- Recent Activities -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Recent Activities</h5>
        </div>
        <div class="card-body">
            {% if recent_activities %}
            <div class="list-group">
                {% for activity in recent_activities %}
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">{{ activity.type | title }} - {{ activity.action | title }}</h6>
                        <small>{{ activity.timestamp }}</small>
                    </div>
                    <p class="mb-1">{{ activity.details.message }}</p>
                    <small>By {{ activity.user_name }}</small>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">No recent activities</p>
            {% endif %}
        </div>
    </div>
            </button>
        </div>
    </div>

    <!-- User Management Section -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-people me-2"></i>User Management</h5>
            <button class="btn btn-sm btn-success" onclick="exportUsers()">
                <i class="bi bi-download me-1"></i>Export Users
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Resume</th>
                            <th>Permit</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr>
                            <td colspan="7" class="text-center">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pending Documents Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-file-earmark-check me-2"></i>Pending Document Reviews</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Document Type</th>
                            <th>Submitted Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pending-docs-table-body">
                        <tr>
                            <td colspan="4" class="text-center">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Stats Cards Row -->
    <div class="row g-4 mb-4">
        <!-- Users Card -->
        <div class="col-md-6 col-xl-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Total Users</h6>
                    <h2 class="card-title mb-0" id="total-users">Loading...</h2>
                    <div class="mt-3" style="height: 100px;">
                        <canvas id="userRolesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Businesses Card -->
        <div class="col-md-6 col-xl-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Total Businesses</h6>
                    <h2 class="card-title" id="total-businesses">Loading...</h2>
                </div>
            </div>
        </div>
        
        <!-- Jobs Card -->
        <div class="col-md-6 col-xl-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Total Jobs</h6>
                    <h2 class="card-title" id="total-jobs">Loading...</h2>
                </div>
            </div>
        </div>
        
        <!-- Services Card -->
        <div class="col-md-6 col-xl-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Total Services</h6>
                    <h2 class="card-title" id="total-services">Loading...</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <!-- Applications Chart -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Application Status Distribution</h5>
                    <canvas id="applicationChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Recent Activity</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="activity-table">
                                <tr>
                                    <td colspan="2" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Dashboard JavaScript -->
<script>
let userRolesChart = null;
let applicationChart = null;

// Initialize charts
function initCharts() {
    // User roles pie chart
    const userRolesCtx = document.getElementById('userRolesChart').getContext('2d');
    userRolesChart = new Chart(userRolesCtx, {
        type: 'pie',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12
                    }
                }
            }
        }
    });

    // Application status bar chart
    const applicationCtx = document.getElementById('applicationChart').getContext('2d');
    applicationChart = new Chart(applicationCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Applications',
                data: [],
                backgroundColor: 'rgba(54, 162, 235, 0.8)'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
}

// Admin Management Functions
function deactivateUser(userId) {
    if (!confirm('Are you sure you want to deactivate this user?')) return;
    
    const form = new FormData();
    form.append('action', 'deactivate');
    form.append('user_id', userId);
    
    fetchWithCSRF('/admin/users', {
        method: 'POST',
        body: form
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateDashboard();
            alert('User deactivated successfully');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => alert('Error: ' + error));
}

function verifyBusiness(businessId, action) {
    if (!confirm(`Are you sure you want to ${action} this business?`)) return;
    
    const form = new FormData();
    form.append('action', action);
    form.append('business_id', businessId);
    
    fetch('/admin/businesses', {
        method: 'POST',
        body: form
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateDashboard();
            alert('Business ' + action + 'd successfully');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => alert('Error: ' + error));
}

function removeContent(contentType, contentId) {
    if (!confirm('Are you sure you want to remove this content?')) return;
    
    const form = new FormData();
    form.append('action', 'remove');
    form.append('content_type', contentType);
    form.append('content_id', contentId);
    
    fetch('/admin/content', {
        method: 'POST',
        body: form
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateDashboard();
            alert('Content removed successfully');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => alert('Error: ' + error));
}

// CSRF Token handling
const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

// Add CSRF token to all fetch requests
function fetchWithCSRF(url, options = {}) {
    return fetch(url, {
        ...options,
        headers: {
            ...options.headers,
            'X-CSRF-Token': csrfToken
        }
    });
}

// Error handling
function handleError(error, message = 'An error occurred', tableId = null) {
    console.error(error);
    const toast = `
        <div class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    document.getElementById('toast-container').innerHTML += toast;
    const toastElement = document.querySelector('.toast:last-child');
    const bsToast = new bootstrap.Toast(toastElement);
    bsToast.show();

    // Update table to show error state if a table ID is provided
    if (tableId) {
        const tableBody = document.getElementById(tableId);
        if (tableBody) {
            const colSpan = tableBody.closest('table').querySelectorAll('th').length || 1;
            tableBody.innerHTML = `
                <tr>
                    <td colspan="${colSpan}" class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>${message}
                    </td>
                </tr>
            `;
        }
    }
}

// Update dashboard data
function updateDashboard() {
    fetchWithCSRF('/admin/dashboard/data')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error fetching stats:', data.error);
                return;
            }

            // Update counters
            const totalUsers = data.users.reduce((sum, role) => sum + role.count, 0);
            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('total-businesses').textContent = data.businesses;
            document.getElementById('total-jobs').textContent = data.jobs;
            document.getElementById('total-services').textContent = data.services;

            // Update user roles chart
            userRolesChart.data.labels = data.users.map(role => role.role);
            userRolesChart.data.datasets[0].data = data.users.map(role => role.count);
            userRolesChart.update();

            // Update application status chart
            applicationChart.data.labels = data.applications.map(app => app.status);
            applicationChart.data.datasets[0].data = data.applications.map(app => app.count);
            applicationChart.update();

            // Update activity table
            const activityTable = document.getElementById('activity-table');
            activityTable.innerHTML = data.recent_activity.map(activity => {
                let actionText = '';
                switch(activity.type) {
                    case 'user_management':
                        actionText = `${activity.user_name} ${activity.action} user`;
                        break;
                    case 'business_verification':
                        actionText = `${activity.user_name} ${activity.action} business registration`;
                        break;
                    case 'content_moderation':
                        actionText = `${activity.user_name} ${activity.action} ${activity.target_type}`;
                        break;
                    default:
                        actionText = activity.action;
                }
                return `
                    <tr>
                        <td>${actionText}</td>
                        <td>${new Date(activity.timestamp).toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        })
        .catch(error => console.error('Error:', error));
}

// Management Functions
async function loadUsers() {
    try {
        const response = await fetchWithCSRF('/admin/users/list');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        if (!Array.isArray(data) || data.length === 0) {
            document.getElementById('users-table-body').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center">No users found</td>
                </tr>
            `;
            return;
        }
        
        const userRows = data.map(user => `
            <tr>
                <td>${user.full_name || user.email}</td>
                <td>${user.email}</td>
                <td>${user.role}</td>
                <td>${user.resume_path ? '<a href="/download/resume/' + user.id + '">View</a>' : 'N/A'}</td>
                <td>${user.permit_path ? '<a href="/download/permit/' + user.id + '">View</a>' : 'N/A'}</td>
                <td>${user.verification_status || 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="manageUser('deactivate', '${user.id}')">
                        ${user.verification_status === 'active' ? 'Deactivate' : 'Activate'}
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="manageUser('delete', '${user.id}')">
                        Delete
                    </button>
                </td>
            </tr>
        `).join('');
        
        document.getElementById('users-table-body').innerHTML = userRows;
    } catch (error) {
        handleError(error, 'Error loading users', 'users-table-body');
    }
}

async function loadBusinesses() {
    try {
        const response = await fetchWithCSRF('/admin/businesses/list');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        if (!Array.isArray(data) || data.length === 0) {
            document.getElementById('businesses-table').innerHTML = `
                <tr>
                    <td colspan="4" class="text-center">No businesses found</td>
                </tr>
            `;
            return;
        }
        
        const businessRows = data.map(business => `
            <tr>
                <td>${business.name}</td>
                <td>${business.owner_name || 'N/A'}</td>
                <td>${business.verification_status || 'Pending'}</td>
                <td>
                    ${business.verification_status !== 'verified' ? `
                        <button class="btn btn-sm btn-success" onclick="manageBusiness('approve', '${business.id}')">
                            Approve
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="manageBusiness('deny', '${business.id}')">
                            Deny
                        </button>
                    ` : ''}
                </td>
            </tr>
        `).join('');
        
        document.getElementById('businesses-table').innerHTML = businessRows;
    } catch (error) {
        handleError(error, 'Error loading businesses', 'businesses-table');
    }
}

async function loadContent() {
    try {
        const response = await fetchWithCSRF('/admin/content');
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        const jobRows = data.jobs.map(job => `
            <tr>
                <td>${job.title}</td>
                <td>${job.business_name}</td>
                <td>${new Date(job.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="manageContent('remove', 'job', '${job.id}')">
                        Remove
                    </button>
                </td>
            </tr>
        `).join('');
        
        const serviceRows = data.services.map(service => `
            <tr>
                <td>${service.title}</td>
                <td>${service.client_name}</td>
                <td>${service.status}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="manageContent('remove', 'service', '${service.id}')">
                        Remove
                    </button>
                </td>
            </tr>
        `).join('');
        
        document.getElementById('jobs-table').innerHTML = jobRows;
        document.getElementById('services-table').innerHTML = serviceRows;
    } catch (error) {
        handleError(error, 'Error loading content');
    }
}

async function manageUser(action, userId) {
    if (!confirm(`Are you sure you want to ${action} this user?`)) return;
    
    try {
        const form = new FormData();
        form.append('action', action);
        form.append('user_id', userId);
        
        const response = await fetchWithCSRF('/admin/users', {
            method: 'POST',
            body: form
        });
        
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        // Refresh data
        updateDashboard();
        loadUsers();
    } catch (error) {
        handleError(error, 'Error managing user');
    }
}

async function manageBusiness(action, businessId) {
    if (!confirm(`Are you sure you want to ${action} this business?`)) return;
    
    try {
        const form = new FormData();
        form.append('action', action);
        form.append('business_id', businessId);
        
        const response = await fetchWithCSRF('/admin/businesses', {
            method: 'POST',
            body: form
        });
        
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        // Refresh data
        updateDashboard();
        loadBusinesses();
    } catch (error) {
        handleError(error, 'Error managing business');
    }
}

async function manageContent(action, contentType, contentId) {
    if (!confirm(`Are you sure you want to ${action} this ${contentType}?`)) return;
    
    try {
        const form = new FormData();
        form.append('action', action);
        form.append('content_type', contentType);
        form.append('content_id', contentId);
        
        const response = await fetchWithCSRF('/admin/content', {
            method: 'POST',
            body: form
        });
        
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        // Refresh data
        updateDashboard();
        loadContent();
    } catch (error) {
        handleError(error, `Error managing ${contentType}`);
    }
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', () => {
    initCharts();
    updateDashboard();
    loadUsers();
    loadBusinesses();
    loadContent();
    // Update every 30 seconds
    setInterval(() => {
        updateDashboard();
        loadUsers();
        loadBusinesses();
        loadContent();
    }, 30000);
});
</script>
{% endblock content %}