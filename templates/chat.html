{% extends "base.html" %}

{% block title %}AI Assistant - Catanduanes Connect{% endblock %}

{% block styles %}
<style>
    .chat-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 1rem;
    }

    .suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .suggestions .btn {
        transition: all 0.2s ease;
        font-size: 0.9rem;
    }

    .suggestions .btn:hover {
        transform: translateY(-1px);
    }

    .chat-window {
        height: 500px;
        border: 1px solid #e9ecef;
        border-radius: 0.5rem;
        background: #fff;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chat-header {
        padding: 1rem;
        background: #0d6efd;
        color: white;
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }

    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    .message {
        margin-bottom: 1rem;
        opacity: 0;
        transform: translateY(20px);
        animation: messageAppear 0.3s forwards;
    }

    @keyframes messageAppear {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-content {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        position: relative;
    }

    .user-message {
        display: flex;
        justify-content: flex-end;
    }

    .user-message .message-content {
        background: #0d6efd;
        color: white;
        border-bottom-right-radius: 0.25rem;
    }

    .bot-message .message-content {
        background: #f8f9fa;
        border-bottom-left-radius: 0.25rem;
    }

    .typing-indicator {
        display: none;
        padding: 0.75rem 1rem;
        background: #f8f9fa;
        border-radius: 1rem;
        margin-bottom: 1rem;
        width: fit-content;
    }

    .typing-indicator span {
        display: inline-block;
        width: 0.5rem;
        height: 0.5rem;
        background: #0d6efd;
        border-radius: 50%;
        margin-right: 0.25rem;
        animation: typing 1s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-0.5rem); }
    }

    .chat-input {
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Catanduanes Connect Assistant</h4>
        </div>
        <div class="card-body p-0">
            <div class="chat-box" id="chatBox">
                <!-- Initial welcome message -->
                <div class="message bot-message">
                    <div class="message-content">
                        <p class="mb-0">Hello! I'm your Catanduanes Connect Assistant. How can I help you today?</p>
                    </div>
                </div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <span></span><span></span><span></span>
            </div>
            <div class="chat-input p-3">
                <form id="chatForm" class="d-flex gap-2">
                    <input type="text" 
                           id="messageInput" 
                           class="form-control" 
                           placeholder="Type your message here..." 
                           required>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const chatBox = document.getElementById('chatBox');
const chatForm = document.getElementById('chatForm');
const messageInput = document.getElementById('messageInput');
const typingIndicator = document.getElementById('typingIndicator');

// Function to handle suggestion selection
function selectSuggestion(text) {
    messageInput.value = text;
    chatForm.dispatchEvent(new Event('submit'));
}

function appendMessage(content, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
    messageDiv.innerHTML = `
        <div class="message-content">
            <p class="mb-0">${content}</p>
        </div>
    `;
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function showTypingIndicator() {
    typingIndicator.style.display = 'block';
    chatBox.scrollTop = chatBox.scrollHeight;
}

function hideTypingIndicator() {
    typingIndicator.style.display = 'none';
}

chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = messageInput.value.trim();
    if (!message) return;

    // Display user message
    appendMessage(message, true);
    messageInput.value = '';
    
    // Show typing indicator
    showTypingIndicator();

    try {
        const response = await fetch('/chatbot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message })
        });

        const data = await response.json();
        
        // Hide typing indicator
        hideTypingIndicator();

        if (data.error) {
            appendMessage(`<span class="text-danger">${data.error}</span>`);
            return;
        }

        // Display bot response from Flowise (includes message with optional suggestions)
        const botResponse = data.message || 'I did not understand that.';
        appendMessage(botResponse);

        // Handle any suggestions from Flowise
        if (data.suggestions && Array.isArray(data.suggestions) && data.suggestions.length > 0) {
            const suggestionsHtml = `
                <div class="suggestions mt-2">
                    ${data.suggestions.map(suggestion => 
                        `<button class="btn btn-sm btn-outline-primary me-2 mb-2" 
                                onclick="selectSuggestion('${suggestion}')">${suggestion}</button>`
                    ).join('')}
                </div>
            `;
            appendMessage(suggestionsHtml);

    } catch (error) {
        console.error('Error:', error);
        hideTypingIndicator();
        appendMessage('Sorry, I encountered an error. Please try again.');
    }
});
</script>
{% endblock %}